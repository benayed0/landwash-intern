<h2 mat-dialog-title>
  <mat-icon>person_add</mat-icon>
  Ajouter un nouveau personnel
</h2>

<mat-dialog-content>
  <form (ngSubmit)="onSubmit()" #personalForm="ngForm">
    <!-- Name Field -->
    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Nom complet</mat-label>
      <input
        matInput
        [(ngModel)]="newPersonal.name"
        name="name"
        placeholder="Ex: Jean Dupont"
        required
        [disabled]="isSubmitting"
      />
      <mat-icon matPrefix>person</mat-icon>
      <mat-error *ngIf="nameError">{{ nameError }}</mat-error>
    </mat-form-field>

    <!-- Email Field -->
    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Adresse email</mat-label>
      <input
        matInput
        type="email"
        [(ngModel)]="newPersonal.email"
        name="email"
        placeholder="Ex: jean.dupont@example.com"
        required
        [disabled]="isSubmitting"
      />
      <mat-icon matPrefix>email</mat-icon>
      <mat-error *ngIf="emailError">{{ emailError }}</mat-error>
    </mat-form-field>

    <!-- Phone Field (Optional) -->
    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Téléphone (optionnel)</mat-label>
      <input
        matInput
        type="tel"
        [(ngModel)]="newPersonal.phone"
        name="phone"
        placeholder="Ex: +216 XX XXX XXX"
        [disabled]="isSubmitting"
      />
      <mat-icon matPrefix>phone</mat-icon>
    </mat-form-field>

    <!-- Role Field -->
    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Rôle</mat-label>
      <mat-select
        [(ngModel)]="newPersonal.role"
        name="role"
        required
        [disabled]="isSubmitting"
      >
        <mat-option value="worker">
          <mat-icon>engineering</mat-icon>
          Travailleur
        </mat-option>
        <!-- Admin option can be enabled later -->
        <mat-option value="partner">
          <mat-icon>person_apron</mat-icon>
          Partenaire
        </mat-option>
      </mat-select>
      <mat-icon matPrefix>badge</mat-icon>
    </mat-form-field>
    @if(newPersonal.role==='partner'){
    <!-- Services Field (Only for Partners) -->
    <div class="services-section">
      <div class="services-header">
        <mat-icon>build</mat-icon>
        <h3>Services attribués</h3>
        <span class="service-count"
          >{{ getSelectedServicesCount() }} sélectionné(s)</span
        >
      </div>
      <p class="services-hint">
        Sélectionnez les types de services que ce partenaire peut effectuer
      </p>

      <div class="services-grid">
        <div
          *ngFor="let serviceGroup of getGroupedServices()"
          class="service-card"
          [class.selected]="isServiceTypeSelected(serviceGroup.type)"
          (click)="toggleServiceType(serviceGroup.type)"
        >
          <div class="service-card-header">
            <div class="service-icon">
              {{ getServiceTypeIcon(serviceGroup.type) }}
            </div>
            <div class="service-info">
              <h4 class="service-name">
                {{ getServiceTypeLabel(serviceGroup.type) }}
              </h4>
              <span class="service-variations"
                >3 variations (Citadines, SUV, Pickup)</span
              >
            </div>
          </div>
          <div class="service-checkbox">
            <mat-icon *ngIf="isServiceTypeSelected(serviceGroup.type)"
              >check_circle</mat-icon
            >
            <mat-icon *ngIf="!isServiceTypeSelected(serviceGroup.type)"
              >radio_button_unchecked</mat-icon
            >
          </div>
        </div>
      </div>

      <div class="select-all-actions" *ngIf="getGroupedServices().length > 0">
        <button
          mat-stroked-button
          type="button"
          class="select-action-btn"
          (click)="selectAllServices()"
          [disabled]="isSubmitting"
        >
          <mat-icon>done_all</mat-icon>
          Tout sélectionner
        </button>
        <button
          mat-stroked-button
          type="button"
          class="select-action-btn"
          (click)="deselectAllServices()"
          [disabled]="isSubmitting"
        >
          <mat-icon>clear</mat-icon>
          Tout désélectionner
        </button>
      </div>
    </div>
    }
    {{ passwordVisible }}
    <!-- Password Field with Generator -->
    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Mot de passe généré</mat-label>
      <input
        matInput
        [type]="passwordVisible ? 'text' : 'password'"
        [(ngModel)]="newPersonal.password"
        name="password"
        readonly
        [disabled]="isSubmitting"
      />
      <mat-icon matPrefix>lock</mat-icon>
      <button
        mat-icon-button
        matSuffix
        type="button"
        (click)="togglePasswordVisibility()"
        [disabled]="isSubmitting"
        [attr.aria-label]="'Toggle password visibility'"
      >
        <mat-icon>{{
          passwordVisible ? "visibility_off" : "visibility"
        }}</mat-icon>
      </button>
    </mat-form-field>

    <!-- Password Actions -->
    <div class="password-actions">
      <button
        mat-stroked-button
        type="button"
        class="action-btn copy-btn"
        (click)="copyPassword()"
        [disabled]="isSubmitting"
      >
        <mat-icon>content_copy</mat-icon>
        Copier
      </button>
      <button
        mat-stroked-button
        type="button"
        class="action-btn"
        (click)="regeneratePassword()"
        [disabled]="isSubmitting"
      >
        <mat-icon>refresh</mat-icon>
        Régénérer
      </button>
    </div>

    <mat-hint class="password-hint">
      <mat-icon inline>info</mat-icon>
      Copiez ce mot de passe et communiquez-le au nouveau personnel de manière
      sécurisée.
    </mat-hint>

    <!-- Info Message -->
    <div class="info-message">
      <mat-icon>email</mat-icon>
      <p>
        Un email de bienvenue sera envoyé à l'adresse indiquée avec les
        instructions de connexion.
      </p>
    </div>
  </form>
</mat-dialog-content>

<mat-dialog-actions align="end">
  <button
    mat-stroked-button
    type="button"
    (click)="onCancel()"
    [disabled]="isSubmitting"
  >
    <mat-icon>close</mat-icon>
    Annuler
  </button>
  <button
    mat-raised-button
    color="primary"
    type="button"
    (click)="onSubmit()"
    [disabled]="isSubmitting"
  >
    <mat-icon *ngIf="!isSubmitting">check</mat-icon>
    <mat-icon *ngIf="isSubmitting" class="spinning">hourglass_empty</mat-icon>
    <span *ngIf="!isSubmitting">Créer le compte</span>
    <span *ngIf="isSubmitting">Création...</span>
  </button>
</mat-dialog-actions>
