<h2 mat-dialog-title>
  <mat-icon>edit</mat-icon>
  Modifier l'équipe
</h2>

<mat-dialog-content>
  <form (ngSubmit)="onSubmit()" #teamForm="ngForm">
    <!-- Name Field -->
    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Nom de l'équipe</mat-label>
      <input
        matInput
        [(ngModel)]="editedTeam.name"
        name="teamName"
        placeholder="Ex: Équipe Nord"
        required
        [disabled]="isSubmitting"
      />
      <mat-icon matPrefix>label</mat-icon>
      <mat-error *ngIf="nameError">{{ nameError }}</mat-error>
    </mat-form-field>

    <!-- Members Selection -->
    <div class="form-section">
      <div class="section-header">
        <mat-icon>people</mat-icon>
        <h3>Membres de l'équipe</h3>
      </div>
      <p class="helper-text">
        <mat-icon inline>info</mat-icon>
        Cliquez pour sélectionner les membres • Activez le toggle "Chef" pour désigner le chef d'équipe
      </p>
      <div class="members-list" *ngIf="availablePersonals.length > 0">
        <div
          class="member-item"
          *ngFor="let personal of availablePersonals"
          [class.selected]="isPersonalSelected(personal._id!)"
          [class.chief]="isChief(personal._id!)"
        >
          <mat-checkbox
            [checked]="isPersonalSelected(personal._id!)"
            (change)="onPersonalToggle(personal._id!)"
            color="primary"
          ></mat-checkbox>
          <div class="member-avatar">
            {{ personal.name.charAt(0).toUpperCase() }}
          </div>
          <div class="member-info" (click)="onPersonalToggle(personal._id!)">
            <div class="member-name">
              {{ personal.name }}
              <mat-icon *ngIf="isChief(personal._id!)" class="chief-badge">star</mat-icon>
            </div>
            <div class="member-details">{{ personal.email }}</div>
          </div>
          <div class="chief-toggle-container">
            <span class="chief-label">Chef</span>
            <mat-slide-toggle
              [checked]="isChief(personal._id!)"
              (change)="onChiefToggle(personal._id!, $event.checked)"
              [disabled]="!isPersonalSelected(personal._id!)"
              color="warn"
            ></mat-slide-toggle>
          </div>
        </div>
      </div>
      <div class="empty-state" *ngIf="availablePersonals.length === 0">
        <mat-icon>person_off</mat-icon>
        <p>Aucun personnel disponible</p>
      </div>
    </div>

    <!-- Service Locations Selection -->
    <div class="form-section">
      <div class="section-header">
        <mat-icon>pin_drop</mat-icon>
        <h3>Localisations de service</h3>
      </div>
      <p class="helper-text">
        <mat-icon inline>info</mat-icon>
        Sélectionnez les localisations où cette équipe peut travailler
      </p>
      <div class="locations-loading" *ngIf="locationsLoading">
        <mat-icon class="spinning">hourglass_empty</mat-icon>
        <span>Chargement des localisations...</span>
      </div>
      <div class="locations-list" *ngIf="!locationsLoading && availableLocations.length > 0">
        <div
          class="location-item"
          *ngFor="let location of availableLocations"
          [class.selected]="isLocationSelected(location._id!)"
          (click)="onLocationToggle(location._id!)"
        >
          <mat-checkbox
            [checked]="isLocationSelected(location._id!)"
            (change)="onLocationToggle(location._id!)"
            (click)="$event.stopPropagation()"
            color="primary"
          ></mat-checkbox>
          <div class="location-icon">
            <mat-icon>place</mat-icon>
          </div>
          <div class="location-details">
            <div class="location-address">{{ location.address }}</div>
            <div class="location-coords">
              <mat-icon>my_location</mat-icon>
              {{ location.coordinates[1].toFixed(4) }}, {{ location.coordinates[0].toFixed(4) }}
            </div>
          </div>
        </div>
      </div>
      <div class="empty-state" *ngIf="!locationsLoading && availableLocations.length === 0">
        <mat-icon>location_off</mat-icon>
        <p>Aucune localisation disponible</p>
      </div>
    </div>

    <!-- Location Selection -->
    <div class="form-section">
      <div class="section-header">
        <mat-icon>location_on</mat-icon>
        <h3>Localisation de l'équipe (optionnel)</h3>
      </div>
      <div class="location-info" *ngIf="editedTeam.coordinates">
        <div class="coordinate-item">
          <mat-icon>my_location</mat-icon>
          <span>Latitude: {{ editedTeam.coordinates[1].toFixed(6) }}</span>
        </div>
        <div class="coordinate-item">
          <mat-icon>place</mat-icon>
          <span>Longitude: {{ editedTeam.coordinates[0].toFixed(6) }}</span>
        </div>
      </div>
      <div class="map-container">
        <div #mapContainer class="map"></div>
        <p class="map-hint">
          <mat-icon inline>touch_app</mat-icon>
          Cliquez sur la carte pour modifier la localisation de l'équipe
        </p>
      </div>
    </div>

    <!-- Radius Selection -->
    <div class="form-section">
      <div class="section-header">
        <mat-icon>radio_button_unchecked</mat-icon>
        <h3>Rayon d'action</h3>
      </div>
      <div class="radius-container">
        <mat-slider
          [min]="1000"
          [max]="100000"
          [step]="1000"
          class="radius-slider"
          [disabled]="isSubmitting"
        >
          <input
            matSliderThumb
            [(ngModel)]="editedTeam.radius"
            name="radius"
            (input)="onRadiusChange()"
          />
        </mat-slider>
        <div class="radius-value">
          <mat-icon>straighten</mat-icon>
          {{ editedTeam.radius! / 1000 | number : "1.0-0" }} km
        </div>
      </div>
      <div class="radius-labels">
        <span>1 km</span>
        <span>100 km</span>
      </div>
    </div>
  </form>
</mat-dialog-content>

<mat-dialog-actions align="end">
  <button
    mat-stroked-button
    type="button"
    (click)="onCancel()"
    [disabled]="isSubmitting"
  >
    <mat-icon>close</mat-icon>
    Annuler
  </button>
  <button
    mat-raised-button
    color="primary"
    type="button"
    (click)="onSubmit()"
    [disabled]="isSubmitting"
  >
    <mat-icon *ngIf="!isSubmitting">check</mat-icon>
    <mat-icon *ngIf="isSubmitting" class="spinning">hourglass_empty</mat-icon>
    <span *ngIf="!isSubmitting">Mettre à jour</span>
    <span *ngIf="isSubmitting">Mise à jour...</span>
  </button>
</mat-dialog-actions>
