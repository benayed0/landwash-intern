<div class="teams-container">
  <div class="content">
    <app-loading-spinner
      *ngIf="loading"
      [size]="'medium'"
      [message]="'Chargement des √©quipes...'"
      [color]="'primary'"
    >
    </app-loading-spinner>

    <div *ngIf="!loading">
      <!-- Tab Navigation -->
      <div class="tabs-container">
        <button
          class="tab-btn"
          [class.active]="activeTab === 'teams'"
          (click)="switchTab('teams')"
        >
          √âquipes
          <span class="tab-count">{{ filteredTeams.length }}</span>
        </button>
        <button
          class="tab-btn"
          [class.active]="activeTab === 'personnel'"
          (click)="switchTab('personnel')"
        >
          Personnel
          <span class="tab-count">{{ filteredPersonals.length }}</span>
        </button>
      </div>

      <!-- Search Bar with Sort & Filter -->
      <div class="search-container">
        <div class="search-controls">
          <div class="search-input-wrapper">
            <input
              type="text"
              [(ngModel)]="searchTerm"
              (input)="onSearchChange()"
              [placeholder]="
                activeTab === 'teams'
                  ? 'Rechercher √©quipes...'
                  : 'Rechercher personnel...'
              "
              class="search-input"
            />
            <button
              *ngIf="searchTerm"
              class="clear-search-btn"
              (click)="clearSearch()"
            >
              ‚úï
            </button>
            <div class="search-icon">üîç</div>
          </div>

          <!-- Sort & Filter Buttons for Teams -->
          <div class="action-buttons" *ngIf="activeTab === 'teams'">
            <button
              class="control-btn"
              [class.active]="showTeamSortMenu"
              (click)="toggleTeamSortMenu()"
              title="Trier"
            >
              <span class="btn-icon">‚áÖ</span>
            </button>
          </div>

          <!-- Sort & Filter Buttons for Personnel -->
          <div class="action-buttons" *ngIf="activeTab === 'personnel'">
            <button
              class="control-btn"
              [class.active]="showPersonalSortMenu"
              (click)="togglePersonalSortMenu()"
              title="Trier"
            >
              <span class="btn-icon">‚áÖ</span>
            </button>
            <button
              class="control-btn"
              [class.active]="
                showPersonalFilterPanel || getActiveRoleFiltersCount() > 0
              "
              (click)="togglePersonalFilterPanel()"
              title="Filtrer"
            >
              <span class="btn-icon">‚ö°</span>
              <span class="badge" *ngIf="getActiveRoleFiltersCount() > 0">{{
                getActiveRoleFiltersCount()
              }}</span>
            </button>
          </div>
        </div>

        <!-- Team Sort Menu -->
        <div
          class="sort-menu"
          *ngIf="showTeamSortMenu && activeTab === 'teams'"
        >
          <div class="menu-header">
            <span>Trier par</span>
          </div>
          <button
            class="menu-item"
            [class.active]="teamSortBy === 'name'"
            (click)="setTeamSortBy('name')"
          >
            <span>üìù Nom</span>
            <span class="sort-indicator" *ngIf="teamSortBy === 'name'">
              {{ teamSortOrder === "asc" ? "‚Üë" : "‚Üì" }}
            </span>
          </button>
          <button
            class="menu-item"
            [class.active]="teamSortBy === 'members'"
            (click)="setTeamSortBy('members')"
          >
            <span>üë• Nombre de membres</span>
            <span class="sort-indicator" *ngIf="teamSortBy === 'members'">
              {{ teamSortOrder === "asc" ? "‚Üë" : "‚Üì" }}
            </span>
          </button>
        </div>

        <!-- Personal Sort Menu -->
        <div
          class="sort-menu"
          *ngIf="showPersonalSortMenu && activeTab === 'personnel'"
        >
          <div class="menu-header">
            <span>Trier par</span>
          </div>
          <button
            class="menu-item"
            [class.active]="personalSortBy === 'name'"
            (click)="setPersonalSortBy('name')"
          >
            <span>üë§ Nom</span>
            <span class="sort-indicator" *ngIf="personalSortBy === 'name'">
              {{ personalSortOrder === "asc" ? "‚Üë" : "‚Üì" }}
            </span>
          </button>
          <button
            class="menu-item"
            [class.active]="personalSortBy === 'role'"
            (click)="setPersonalSortBy('role')"
          >
            <span>‚≠ê R√¥le</span>
            <span class="sort-indicator" *ngIf="personalSortBy === 'role'">
              {{ personalSortOrder === "asc" ? "‚Üë" : "‚Üì" }}
            </span>
          </button>
        </div>

        <!-- Personal Filter Panel -->
        <div
          class="filter-panel"
          *ngIf="showPersonalFilterPanel && activeTab === 'personnel'"
        >
          <div class="menu-header">
            <span>Filtrer par r√¥le</span>
            <button
              class="clear-filters-btn"
              *ngIf="getActiveRoleFiltersCount() > 0"
              (click)="clearPersonalFilters()"
            >
              R√©initialiser
            </button>
          </div>
          <label class="filter-checkbox">
            <input
              type="checkbox"
              [(ngModel)]="roleFilters.admin"
              (change)="toggleRoleFilter('admin')"
            />
            <span class="checkbox-custom"></span>
            <span class="checkbox-label">
              <span class="role-badge-mini admin">Admin</span>
              Administrateurs
            </span>
          </label>
          <label class="filter-checkbox">
            <input
              type="checkbox"
              [(ngModel)]="roleFilters.worker"
              (change)="toggleRoleFilter('worker')"
            />
            <span class="checkbox-custom"></span>
            <span class="checkbox-label">
              <span class="role-badge-mini worker">Worker</span>
              Employ√©s
            </span>
          </label>
        </div>
      </div>

      <!-- Teams Section -->
      <div *ngIf="activeTab === 'teams'">
        <div
          *ngIf="filteredTeams.length === 0 && !searchTerm"
          class="empty-state"
        >
          <p>Aucune √©quipe disponible</p>
          <button
            class="add-btn-icon"
            (click)="openCreateTeamModal()"
            title="Cr√©er une √©quipe"
          >
            ‚ûï
          </button>
        </div>

        <div
          *ngIf="filteredTeams.length === 0 && searchTerm"
          class="empty-state"
        >
          <p>Aucun r√©sultat trouv√© pour "{{ searchTerm }}"</p>
        </div>

        <!-- Teams Table -->
        <div class="table-container" *ngIf="filteredTeams.length > 0">
          <table class="data-table">
            <thead>
              <tr>
                <th>√âquipe</th>
                <th>Membres</th>
                <th class="hide-mobile">Localisation</th>
                <th>Actions</th>
                <th class="add-column">
                  <button
                    class="add-btn-icon"
                    (click)="openCreateTeamModal()"
                    title="Cr√©er une √©quipe"
                  >
                    ‚ûï
                  </button>
                </th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let team of paginatedTeams">
                <td class="team-info-cell">
                  <div class="team-main-info">
                    <div class="team-name-with-icon">{{ team.name }}</div>
                    <div *ngIf="team.chiefId" class="team-chief-info">
                      <span class="chief-crown">üëë</span>
                      <div class="chief-avatar-mini">
                        {{ getInitials(getChiefInfo(team).name) }}
                      </div>
                      <span class="chief-name-text">{{
                        getChiefInfo(team).name
                      }}</span>
                    </div>
                  </div>
                </td>
                <td>
                  <span class="member-badge">{{
                    team.members?.length || 0
                  }}</span>
                </td>
                <td class="hide-mobile">
                  <div *ngIf="team.coordinates" class="location-cell">
                    <div>
                      üìç {{ team.coordinates[1].toFixed(4) }},
                      {{ team.coordinates[0].toFixed(4) }}
                    </div>
                    <div *ngIf="team.radius" class="radius-text">
                      üéØ {{ team.radius / 1000 }}km
                    </div>
                  </div>
                </td>
                <td>
                  <div class="table-actions">
                    <button
                      class="action-btn edit-btn"
                      (click)="openEditTeam(team)"
                      title="Modifier"
                    >
                      ‚úèÔ∏è
                    </button>
                    <button
                      class="action-btn delete-btn"
                      (click)="openDeleteConfirm(team)"
                      title="Supprimer"
                    >
                      üóëÔ∏è
                    </button>
                  </div>
                </td>
                <td class="add-column"></td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Teams Pagination -->
        <div class="pagination" *ngIf="totalTeamPages > 1">
          <button
            class="pagination-btn"
            [disabled]="currentTeamPage === 1"
            (click)="onTeamPageChange(currentTeamPage - 1)"
          >
            ‚Üê
          </button>

          <button
            *ngFor="let page of getTeamPageNumbers()"
            class="pagination-btn"
            [class.active]="page === currentTeamPage"
            (click)="onTeamPageChange(page)"
          >
            {{ page }}
          </button>

          <button
            class="pagination-btn"
            [disabled]="currentTeamPage === totalTeamPages"
            (click)="onTeamPageChange(currentTeamPage + 1)"
          >
            ‚Üí
          </button>
        </div>
      </div>

      <!-- Personnel Section -->
      <div *ngIf="activeTab === 'personnel'">
        <div
          *ngIf="filteredPersonals.length === 0 && !searchTerm"
          class="empty-state"
        >
          <p>Aucun personnel disponible</p>
          <button
            class="add-btn-icon"
            (click)="openAddPersonalModal()"
            title="Cr√©er un compte"
          >
            ‚ûï
          </button>
        </div>

        <div
          *ngIf="filteredPersonals.length === 0 && searchTerm"
          class="empty-state"
        >
          <p>Aucun personnel trouv√© pour "{{ searchTerm }}"</p>
        </div>

        <!-- Personnel Table -->
        <div class="table-container" *ngIf="filteredPersonals.length > 0">
          <table class="data-table">
            <thead>
              <tr>
                <th>Nom</th>
                <th class="hide-mobile">Email</th>
                <th class="hide-mobile">T√©l√©phone</th>
                <th>R√¥le</th>
                <th class="add-column">
                  <button
                    class="add-btn-icon"
                    (click)="openAddPersonalModal()"
                    title="Cr√©er un compte"
                  >
                    ‚ûï
                  </button>
                </th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let personal of paginatedPersonals">
                <td>
                  <div class="personal-cell">
                    <div class="personal-avatar-small">
                      {{ getInitials(personal.name) }}
                    </div>
                    <span>{{ personal.name }}</span>
                  </div>
                </td>
                <td class="hide-mobile">{{ personal.email }}</td>
                <td class="hide-mobile">{{ personal.phone }}</td>
                <td>
                  <span
                    class="role-badge"
                    [class.admin-badge]="personal.role === 'admin'"
                  >
                    {{ personal.role === "admin" ? "Admin" : "Employ√©" }}
                  </span>
                </td>
                <td class="add-column"></td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Personnel Pagination -->
        <div class="pagination" *ngIf="totalPersonalPages > 1">
          <button
            class="pagination-btn"
            [disabled]="currentPersonalPage === 1"
            (click)="onPersonalPageChange(currentPersonalPage - 1)"
          >
            ‚Üê
          </button>

          <button
            *ngFor="let page of getPersonalPageNumbers()"
            class="pagination-btn"
            [class.active]="page === currentPersonalPage"
            (click)="onPersonalPageChange(page)"
          >
            {{ page }}
          </button>

          <button
            class="pagination-btn"
            [disabled]="currentPersonalPage === totalPersonalPages"
            (click)="onPersonalPageChange(currentPersonalPage + 1)"
          >
            ‚Üí
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
