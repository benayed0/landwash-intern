<div class="booking-card">
  @if (!isEditing) {
  <!-- Normal View -->
  <div class="booking-header">
    <div class="vehicle-type">
      <div class="vehicle-icon">{{ getVehicleIcon(booking.type) }}</div>
      <div class="vehicle-info">
        <span class="vehicle-label">{{
          getVehicleTypeLabel(booking.type)
        }}</span>
        @if (booking.type !== 'salon' && booking.carType) {
        <span class="car-type-badge">{{ getCarTypeLabel(booking.carType) }}</span>
        }
        @if (booking.type === 'salon' && booking.salonsSeats) {
        <span class="salon-seats">{{ booking.salonsSeats }} si√®ges</span>
        }
        @if (booking.colorTone) {
        <span class="color-tone-badge">{{ getColorToneIcon(booking.colorTone) }} {{ getColorToneLabel(booking.colorTone) }}</span>
        }
        <span class="booking-date-compact">{{ formatDate(booking.date) }}</span>
      </div>
    </div>
    <div class="header-right">
      <div class="price-info">
        <span class="booking-price-compact">{{ booking.price }} DT</span>
        <span
          *ngIf="booking.transportFee && booking.transportFee > 0"
          class="transport-fee-badge"
        >
          +{{ booking.transportFee }} DT (Transport)
        </span>
      </div>
      <div class="status-actions">
        <span class="status-badge" [ngClass]="'status-' + booking.status">
          {{
            booking.status === "pending"
              ? "En attente"
              : booking.status === "confirmed"
              ? "Confirm√©"
              : booking.status === "in-progress"
              ? "En cours"
              : booking.status === "completed"
              ? "Termin√©"
              : booking.status === "rejected"
              ? "Rejet√©"
              : booking.status === "canceled"
              ? "Annul√©"
              : booking.status
          }}
        </span>
        @if (canEdit()) {
        <button class="edit-btn-header" (click)="startEdit(); $event.stopPropagation()" title="Modifier">
          ‚úèÔ∏è
        </button>
        }
      </div>
    </div>
  </div>
  } @else {
  <!-- Edit Mode -->
  <div class="edit-header">
    <h3>‚úèÔ∏è Modifier</h3>
    <div class="edit-actions">
      <button
        class="save-btn"
        (click)="saveEdit()"
        [disabled]="!isValidEdit()"
        title="Sauvegarder"
      >
        üíæ
      </button>
      <button class="cancel-btn" (click)="cancelEdit()" title="Annuler">
        ‚úñÔ∏è
      </button>
    </div>
  </div>

  <div class="edit-form">
    <div class="form-group">
      <label>Type de service</label>
      <select
        [(ngModel)]="editForm.type"
        class="form-input"
        (change)="onServiceTypeChange()"
      >
        <option value="detailing">Lavage D√©taill√©</option>
        <option value="salon">Salon</option>
        <option value="paint_correction">Correction de Peinture</option>
        <option value="body_correction">Correction de Carrosserie</option>
        <option value="ceramic_coating">Rev√™tement C√©ramique</option>
      </select>
    </div>

    @if (editForm.type !== 'salon') {
    <div class="form-group">
      <label>Type de v√©hicule</label>
      <select
        [(ngModel)]="editForm.carType"
        class="form-input"
      >
        <option value="small">Citadines / Petites Voitures</option>
        <option value="big">SUV / Grandes Voitures</option>
        <option value="pickup">Pick-up</option>
      </select>
    </div>
    }

    @if (editForm.type === 'salon') {
    <div class="form-group">
      <label>Nombre de si√®ges</label>
      <input
        type="number"
        [(ngModel)]="editForm.salonsSeats"
        min="1"
        max="20"
        class="form-input"
      />
    </div>
    }

    @if (editForm.type === 'paint_correction' || editForm.type === 'body_correction' || editForm.type === 'ceramic_coating') {
    <div class="form-group">
      <label>Teinte de couleur (optionnel)</label>
      <select
        [(ngModel)]="editForm.colorTone"
        class="form-input"
      >
        <option [ngValue]="undefined">Aucune (non sp√©cifi√©)</option>
        <option *ngFor="let colorTone of colorTones" [value]="colorTone.value">
          {{ colorTone.icon }} {{ colorTone.label }}
        </option>
      </select>
    </div>
    }

    <div class="form-group">
      <label>Prix (DT)</label>
      <input
        type="number"
        [(ngModel)]="editForm.price"
        min="0"
        step="0.1"
        class="form-input"
      />
    </div>

    <div class="form-group">
      <label>S√©lectionner une date</label>
      <input
        type="date"
        [(ngModel)]="selectedDateString"
        class="date-input"
        [min]="minDateString"
        (change)="onDateInputChange($event)"
      />
    </div>

    <!-- Available Time Slots Display -->
    @if (selectedDateString && availableTimeSlots().length > 0) {
    <div class="available-slots">
      <label>S√©lectionner un cr√©neau horaire :</label>
      <div class="time-slots">
        <button
          type="button"
          *ngFor="let slot of availableTimeSlots()"
          class="time-slot"
          [class.selected]="selectedTimeSlot === slot"
          (click)="onTimeSlotClick(slot)"
        >
          {{ slot }}
        </button>
      </div>
    </div>
    }

    <!-- No slots available message -->
    @if (selectedDateString && bookedSlots() && availableTimeSlots().length ===
    0) {
    <div class="no-slots">
      <p>
        Aucun cr√©neau disponible pour cette date. Tous les cr√©neaux sont
        r√©serv√©s.
      </p>
    </div>
    }

    <div class="form-group">
      <label>Statut</label>
      <select [(ngModel)]="editForm.status" class="form-input">
        <option value="pending">En attente</option>
        <option value="confirmed">Confirm√©</option>
        <option value="completed">Termin√©</option>
        <option value="rejected">Rejet√©</option>
        <option value="canceled">Annul√©</option>
      </select>
    </div>

    <div class="form-group">
      <label>Adresse</label>

      <!-- Service Location Dropdown (shown when service has locations) -->
      @if (availableServiceLocationsEdit().length > 0) {
        <select
          class="form-input"
          (change)="onServiceLocationChangeEdit($event)"
        >
          <option value="">Choisir une localisation...</option>
          <option
            *ngFor="let location of availableServiceLocationsEdit()"
            [value]="location._id"
            [selected]="location.address === editForm.address"
          >
            {{ location.address }}
          </option>
        </select>
      }

      <!-- Manual Address Textarea (shown when no service locations available) -->
      @if (availableServiceLocationsEdit().length === 0) {
        <textarea
          [(ngModel)]="editForm.address"
          class="form-input textarea"
          rows="2"
        ></textarea>
      }
    </div>

    <div class="form-group">
      <label>Frais de transport (DT)</label>
      <input
        type="number"
        [(ngModel)]="editForm.transportFee"
        class="form-input"
        min="0"
        step="0.5"
        placeholder="0.00"
      />
    </div>

    <div class="form-group checkbox-group">
      <label class="checkbox-label">
        <input
          type="checkbox"
          [(ngModel)]="editForm.withSub"
          class="checkbox"
        />
        <span class="checkmark"></span>
        Avec abonnement
      </label>
    </div>
  </div>
  } @if (!isEditing) {
  <!-- Compact Location -->
  <div class="booking-location" [class.service-location]="isServiceLocation()">
    @if (isServiceLocation()) {
      <!-- Service Location Badge -->
      <div class="service-location-badge">
        <span class="badge-icon">üè¢</span>
        <span class="badge-text">Centre de service</span>
      </div>
    }
    <a
      href="https://www.google.com/maps/search/?api=1&query={{
        booking.coordinates[1]
      }},{{ booking.coordinates[0] }}"
      target="_blank"
      rel="noopener noreferrer"
      class="location-link"
      title="{{ booking.address || 'Adresse non sp√©cifi√©e' }}"
    >
      <span class="location-icon">üìç</span>
      <span class="location-text">{{
        booking.address || "Adresse non sp√©cifi√©e"
      }}</span>
      <span class="location-arrow">‚Üí</span>
    </a>
  </div>

  <!-- Client Information (enhanced for workers) - COLLAPSIBLE -->
  @if (booking.userId) {
  <details class="collapsible-section">
    <summary class="section-header">
      <span class="section-icon">üë§</span>
      <span class="section-title">{{ booking.userId.name || "Client" }}</span>
      <span class="expand-icon">‚ñº</span>
    </summary>
    <div class="section-content">
      @if (booking.phoneNumber) {
      <a href="tel:{{ booking.phoneNumber }}" class="contact-item">
        <span class="contact-icon">üì±</span>
        <span class="contact-text">{{ booking.phoneNumber }}</span>
      </a>
      }
    </div>
  </details>
  }

  <!-- Rating Section (only for completed bookings) -->
  @if (booking.status === 'completed' && booking.rating) {
  <div class="rating-compact">
    <app-rating-display
      [rating]="booking.rating"
      variant="compact"
    ></app-rating-display>
  </div>
  }

  <!-- Team Info - COLLAPSIBLE -->
  @if (booking.teamId) {
  <details class="collapsible-section">
    <summary class="section-header">
      <span class="section-icon">üë•</span>
      <span class="section-title">{{ getTeamName(booking.teamId) }}</span>
      @if (userRole === 'admin') {
      <button
        class="icon-btn change-team-icon"
        (click)="triggerRequestReassignTeam(); $event.stopPropagation()"
        title="Changer l'√©quipe"
      >
        üîÑ
      </button>
      }
      <span class="expand-icon">‚ñº</span>
    </summary>
    <div class="section-content">
      @if (booking.teamId && getChiefName(booking.teamId)) {
      <div class="team-chief-info">
        <span class="info-label">Chef:</span>
        <span class="info-value">{{ getChiefName(booking.teamId) }}</span>
      </div>
      }
    </div>
  </details>
  } @if (booking.status === 'pending') {
  <div class="booking-actions compact">
    <button
      class="action-btn confirm-btn"
      (click)="confirmBooking()"
      title="Confirmer"
    >
      <span class="btn-icon">‚úì</span>
      <span class="btn-text">Confirmer</span>
    </button>
    <button
      class="action-btn reject-btn"
      (click)="rejectBooking()"
      title="Rejeter"
    >
      <span class="btn-icon">‚úó</span>
      <span class="btn-text">Rejeter</span>
    </button>
  </div>
  } @if (booking.status === 'confirmed') {
  <!-- Delay Information Display -->
  @if (booking.delayedOf && booking.delayedOf > 0) {
  <div class="delay-info compact">
    <span class="delay-icon">‚è∞</span>
    <span class="delay-text">{{ booking.delayedOf }} min</span>
  </div>
  }

  <div class="booking-actions compact">
    <button
      class="action-btn delay-btn icon-mode"
      (click)="openDelayModal()"
      title="{{
        booking.delayedOf ? 'Modifier le retard' : 'Signaler un retard'
      }}"
    >
      <span class="btn-icon">‚è∞</span>
    </button>
    <button
      class="action-btn start-progress-btn"
      (click)="startProgress()"
      title="Commencer"
    >
      <span class="btn-icon">‚ñ∂Ô∏è</span>
      <span class="btn-text">D√©marrer</span>
    </button>
    <button
      class="action-btn complete-btn"
      (click)="completeBooking()"
      title="Marquer comme termin√©"
    >
      <span class="btn-icon">‚úì</span>
      <span class="btn-text">Terminer</span>
    </button>
    <button
      class="action-btn reject-btn icon-mode"
      (click)="rejectBooking()"
      title="Rejeter"
    >
      <span class="btn-icon">‚úó</span>
    </button>
  </div>
  } @if (booking.status === 'in-progress') {
  <!-- Progress Section -->
  <div class="progress-section compact">
    <div class="progress-header">
      <span class="progress-label">‚è±Ô∏è {{ formatTimeRemaining() }}</span>
      <span class="duration-info">{{ getBookingDuration() }} min</span>
    </div>
    <div class="progress-bar-container">
      <div
        class="progress-bar"
        [style.width.%]="getTimeRemaining().percentage"
      ></div>
    </div>
  </div>

  <div class="booking-actions compact">
    <button
      class="action-btn complete-btn"
      (click)="completeBooking()"
      title="Marquer comme termin√©"
    >
      <span class="btn-icon">‚úì</span>
      <span class="btn-text">Terminer</span>
    </button>
  </div>
  } @if (booking.status === 'rejected') {
  <div class="booking-actions compact">
    <button
      class="action-btn confirm-btn"
      (click)="reconfirmBooking()"
      title="Reconfirmer"
    >
      <span class="btn-icon">üîÑ</span>
      <span class="btn-text">Reconfirmer</span>
    </button>
  </div>
  } }
</div>

<!-- Delay Modal is now handled by MatDialog in the component -->
