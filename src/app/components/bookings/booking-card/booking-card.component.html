<div class="booking-card">
  @if (!isEditing) {
  <!-- Normal View -->
  <div class="booking-header">
    <div class="vehicle-type">
      <div class="vehicle-icon">{{ getVehicleIcon(booking.type) }}</div>
      <span>
        {{ getVehicleTypeLabel(booking.type) }}
        @if (booking.type === 'salon' && booking.salonsSeats) {
        <span class="salon-seats"> ({{ booking.salonsSeats }} si√®ges) </span>
        }
      </span>
    </div>
    <span class="status-badge" [ngClass]="'status-' + booking.status">
      {{
        booking.status === "pending"
          ? "En attente"
          : booking.status === "confirmed"
          ? "Confirm√©"
          : booking.status === "completed"
          ? "Termin√©"
          : booking.status === "rejected"
          ? "Rejet√©"
          : booking.status === "canceled"
          ? "Annul√©"
          : booking.status
      }}
    </span>
  </div>
  } @else {
  <!-- Edit Mode -->
  <div class="edit-header">
    <h3>Modifier la r√©servation</h3>
    <div class="edit-actions">
      <button class="save-btn" (click)="saveEdit()" [disabled]="!isValidEdit()">
        üíæ Sauvegarder
      </button>
      <button class="cancel-btn" (click)="cancelEdit()">‚úñÔ∏è Annuler</button>
    </div>
  </div>

  <div class="edit-form">
    <div class="form-group">
      <label>Type de v√©hicule</label>
      <select [(ngModel)]="editForm.type" class="form-input">
        <option value="small">Citadines / Petites Voitures</option>
        <option value="big">SUV / Grandes Voitures</option>
        <option value="salon">Salon</option>
      </select>
    </div>

    @if (editForm.type === 'salon') {
    <div class="form-group">
      <label>Nombre de si√®ges</label>
      <input
        type="number"
        [(ngModel)]="editForm.salonsSeats"
        min="1"
        max="20"
        class="form-input"
      />
    </div>
    }

    <div class="form-group">
      <label>Prix (DT)</label>
      <input
        type="number"
        [(ngModel)]="editForm.price"
        min="0"
        step="0.1"
        class="form-input"
      />
    </div>

    <div class="form-group">
      <label>Date et heure</label>
      <input
        type="datetime-local"
        [(ngModel)]="editForm.date"
        class="date-input"
      />
    </div>

    <div class="form-group">
      <label>Statut</label>
      <select [(ngModel)]="editForm.status" class="form-input">
        <option value="pending">En attente</option>
        <option value="confirmed">Confirm√©</option>
        <option value="completed">Termin√©</option>
        <option value="rejected">Rejet√©</option>
        <option value="canceled">Annul√©</option>
      </select>
    </div>

    <div class="form-group">
      <label>Adresse</label>
      <textarea
        [(ngModel)]="editForm.address"
        class="form-input textarea"
        rows="2"
      ></textarea>
    </div>

    <div class="form-group">
      <label>Num√©ro secondaire</label>
      <input
        type="tel"
        [(ngModel)]="editForm.secondaryNumber"
        class="form-input"
      />
    </div>

    <div class="form-group checkbox-group">
      <label class="checkbox-label">
        <input
          type="checkbox"
          [(ngModel)]="editForm.withSub"
          class="checkbox"
        />
        <span class="checkmark"></span>
        Avec abonnement
      </label>
    </div>
  </div>
  } @if (!isEditing) {
  <div class="booking-date">üìÖ {{ formatDate(booking.date) }}</div>

  <div class="booking-address">
    <span>üìç</span>
    <span>
      <a
        href="https://www.google.com/maps/search/?api=1&query={{
          booking.coordinates[1]
        }},{{ booking.coordinates[0] }}"
        target="_blank"
        rel="noopener noreferrer"
      >
        {{ booking.address || "Adresse non sp√©cifi√©e" }}
      </a></span
    >
  </div>

  <!-- Client Information (enhanced for workers) -->
  @if (booking.userId) {
  <div class="user-info" [class.worker-view]="userRole === 'worker'">
    @if (booking.userId.name) {
    <div class="client-name">Client: {{ booking.userId.name }}</div>
    } @if (booking.userId.phoneNumber) {
    <div class="client-phone">
      üì±
      <a href="tel:{{ booking.userId.phoneNumber }}" class="client-phone">{{
        booking.userId.phoneNumber
      }}</a>
    </div>
    } @if (booking.secondaryNumber) {
    <div class="client-phone">
      üì± Secondaire:
      <a href="tel:{{ booking.secondaryNumber }}" class="client-phone">{{
        booking.secondaryNumber
      }}</a>
    </div>
    }
  </div>
  }

  <div class="price-section">
    <div class="booking-price">{{ booking.price }} DT</div>
    @if (canEdit()) {
    <button
      class="edit-btn"
      (click)="startEdit()"
      title="Modifier la r√©servation"
    >
      ‚úèÔ∏è Modifier
    </button>
    }
  </div>
  @if (booking.teamId ) {
  <div class="team-info">
    <div class="team-details">
      <span class="team-icon">üë•</span>
      <span class="team-label">√âquipe assign√©e:</span>
      <span class="team-name">{{ getTeamName(booking.teamId) }}</span>
      @if (booking.teamId && getChiefName(booking.teamId)) {
      <span class="team-chief">
        (Chef: {{ getChiefName(booking.teamId) }})
      </span>
      }
    </div>
    @if (userRole === 'admin') {
    <button
      class="change-team-btn"
      (click)="triggerRequestReassignTeam()"
      title="Changer l'√©quipe"
    >
      üîÑ Changer
    </button>
    }
  </div>
  } @if (booking.status === 'pending') {
  <div class="booking-actions">
    <button class="action-btn confirm-btn" (click)="confirmBooking()">
      ‚úì Confirmer
    </button>
    <button class="action-btn reject-btn" (click)="rejectBooking()">
      ‚úó Rejeter
    </button>
  </div>
  } @if (booking.status === 'confirmed') {
  <!-- Delay Information Display -->
  @if (booking.delayedOf && booking.delayedOf > 0) {
  <div class="delay-info">
    <span class="delay-icon">‚è∞</span>
    <span class="delay-text">Retard: {{ booking.delayedOf }} minutes</span>
  </div>
  }

  <div class="booking-actions">
    <button class="action-btn delay-btn" (click)="openDelayModal()">
      ‚è∞ {{ booking.delayedOf ? 'Modifier le retard' : 'Signaler un retard' }}
    </button>
    <button class="action-btn start-progress-btn" (click)="startProgress()">
      ‚ñ∂Ô∏è Commencer
    </button>
    <button class="action-btn complete-btn" (click)="completeBooking()">
      ‚úì Marquer comme termin√©
    </button>
    <button class="action-btn reject-btn" (click)="rejectBooking()">
      ‚úó Rejeter
    </button>
  </div>
  } @if (booking.status === 'in-progress') {
  <!-- Progress Section -->
  <div class="progress-section">
    <div class="progress-header">
      <span class="progress-label">Progression</span>
      <span class="time-remaining">{{ formatTimeRemaining() }}</span>
    </div>
    <div class="progress-bar-container">
      <div
        class="progress-bar"
        [style.width.%]="getTimeRemaining().percentage"
      ></div>
    </div>
    <div class="progress-info">
      <span class="duration-info">
        Dur√©e: {{ getBookingDuration() }} min @if (booking.type === 'salon' &&
        booking.salonsSeats) { ({{ booking.salonsSeats }} si√®ges √ó 20min) }
      </span>
    </div>
  </div>

  <div class="booking-actions">
    <button class="action-btn complete-btn" (click)="completeBooking()">
      ‚úì Marquer comme termin√©
    </button>
  </div>
  } @if (booking.status === 'rejected') {
  <div class="booking-actions">
    <button class="action-btn confirm-btn" (click)="reconfirmBooking()">
      üîÑ Reconfirmer
    </button>
  </div>
  } }
</div>

<!-- Delay Modal is now handled by MatDialog in the component -->
