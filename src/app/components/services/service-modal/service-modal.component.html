<div class="modal-container">
  <div class="modal-header">
    <h2 mat-dialog-title>Modifier le Service</h2>
    <button class="close-btn" (click)="onClose()" type="button">&times;</button>
  </div>

  <form (ngSubmit)="onSubmit()" class="modal-form" mat-dialog-content>
    <!-- Service Type (Non-editable) -->
    <div class="form-group">
      <label for="type">Type de service</label>
      <input
        type="text"
        id="type"
        name="type"
        [value]="getDisplayTypeLabel()"
        readonly
        class="readonly-field"
      />
      <small class="field-hint">
        Le type de service ne peut pas √™tre modifi√©
      </small>
    </div>

    <!-- Variants Section -->
    <div class="form-group">
      <label>Variantes de prix/dur√©e</label>
      <small class="field-hint" *ngIf="formData.type === 'salon'">
        Les services salon ont un prix unique pour tous les types de v√©hicules.
      </small>
      <small class="field-hint" *ngIf="formData.type !== 'salon'">
        D√©finissez les prix et dur√©es pour diff√©rents types de voiture.
      </small>
      <span class="error-message" *ngIf="errors['variants']">{{
        errors["variants"]
      }}</span>

      <!-- List of existing variants -->
      <div class="variants-list">
        <div class="variant-card" *ngFor="let type of getVariantTypes()">
          <div class="variant-header" *ngIf="hasVariant(type)">
            <span class="variant-type">
              <span *ngIf="type === 'all'"
                >üè† Prix unique (tous v√©hicules)</span
              >
              <span *ngIf="type !== 'all'">üöó {{ getCarTypeLabel(type) }}</span>
            </span>
          </div>

          <div class="variant-fields" *ngIf="hasVariant(type)">
            <div class="variant-field">
              <label [for]="'price-' + type">Prix (TND) *</label>
              <input
                type="number"
                [id]="'price-' + type"
                [name]="'price-' + type"
                [ngModel]="getVariantData(type)?.price"
                (ngModelChange)="updateVariant(type, 'price', $event)"
                [class.error]="errors['price_' + type]"
                min="0"
                step="0.01"
                required
              />
              <span class="error-message" *ngIf="errors['price_' + type]">{{
                errors["price_" + type]
              }}</span>
            </div>

            <div class="variant-field">
              <label [for]="'duration-' + type">Dur√©e (min) *</label>
              <input
                type="number"
                [id]="'duration-' + type"
                [name]="'duration-' + type"
                [ngModel]="getVariantData(type)?.duration"
                (ngModelChange)="updateVariant(type, 'duration', $event)"
                [class.error]="errors['duration_' + type]"
                min="1"
                step="5"
                required
              />
              <span class="error-message" *ngIf="errors['duration_' + type]">{{
                errors["duration_" + type]
              }}</span>
            </div>
          </div>

          <!-- Add variant button -->
          <button
            type="button"
            class="add-variant-btn"
            *ngIf="!hasVariant(type)"
            (click)="addVariant(type)"
          >
            <span *ngIf="type === 'all'">+ Ajouter le prix</span>
            <span *ngIf="type !== 'all'"
              >+ Ajouter prix pour {{ getCarTypeLabel(type) }}</span
            >
          </button>
        </div>
      </div>
    </div>

    <!-- Salon Type Message -->
    <div class="form-group" *ngIf="formData.type === 'salon'">
      <div class="info-message">
        <span class="info-icon">‚ÑπÔ∏è</span>
        <span
          >Les services de type "Salon" sont toujours effectu√©s au domicile du
          client. Aucune localisation n'est requise.</span
        >
      </div>
    </div>

    <!-- Available Locations Selection -->
    <div class="form-group" *ngIf="formData.type !== 'salon'">
      <label>Localisations disponibles *</label>
      <span class="error-message" *ngIf="errors['locations']">{{
        errors["locations"]
      }}</span>

      <div class="info-message" *ngIf="getAvailableLocations().length === 0">
        <span class="info-icon">‚ö†Ô∏è</span>
        <span
          >Aucune localisation active disponible. Veuillez d'abord cr√©er des
          localisations dans l'onglet "Localisations".</span
        >
      </div>

      <div
        class="locations-selection"
        *ngIf="getAvailableLocations().length > 0"
      >
        <div
          class="location-checkbox"
          *ngFor="let location of getAvailableLocations()"
        >
          <label class="checkbox-label">
            <input
              type="checkbox"
              [checked]="isLocationSelected(location._id!)"
              (change)="toggleLocation(location._id!)"
            />
            <div class="location-info-check">
              <span class="location-address">{{ location.address }}</span>
              <small class="location-coordinates">
                Lat: {{ location.coordinates[1] | number : "1.4-4" }}, Lng:
                {{ location.coordinates[0] | number : "1.4-4" }}
              </small>
            </div>
          </label>
        </div>
      </div>

      <small class="field-hint">
        S√©lectionnez au moins une localisation o√π ce service est disponible. Les
        localisations peuvent √™tre g√©r√©es dans l'onglet "Localisations".
      </small>
    </div>

    <!-- Form Actions -->
    <div class="form-actions" mat-dialog-actions>
      <button
        type="button"
        class="btn-secondary"
        (click)="onClose()"
        [disabled]="isSubmitting"
      >
        Annuler
      </button>
      <button type="submit" class="btn-primary" [disabled]="isSubmitting">
        {{ isSubmitting ? "Enregistrement..." : "Modifier" }}
      </button>
    </div>
  </form>
</div>
