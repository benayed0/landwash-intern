<div class="services-container">
  <div class="content">
    <div class="page-header">
      <h1>‚öôÔ∏è Services & Localisations</h1>
      <div class="view-toggle">
        <button
          class="toggle-btn"
          [class.active]="viewMode === 'services'"
          (click)="switchView('services')"
        >
          üìã Services
        </button>
        <button
          class="toggle-btn"
          [class.active]="viewMode === 'locations'"
          (click)="switchView('locations')"
        >
          üìç Localisations
        </button>
      </div>
    </div>

    <!-- Services View -->
    <div *ngIf="viewMode === 'services'">
      <!-- Filter Tabs -->
      <div class="filter-tabs" *ngIf="!loading">
        <button
          class="filter-tab"
          [class.active]="selectedType === 'all'"
          (click)="onFilterChange('all')"
        >
          Tous ({{ services.length }})
        </button>
        <button
          class="filter-tab"
          [class.active]="selectedType === 'detailing'"
          (click)="onFilterChange('detailing')"
        >
          {{ getServiceTypeIcon("detailing") }}
          {{ getServiceTypeLabel("detailing") }}
        </button>
        <button
          class="filter-tab"
          [class.active]="selectedType === 'salon'"
          (click)="onFilterChange('salon')"
        >
          {{ getServiceTypeIcon("salon") }} {{ getServiceTypeLabel("salon") }}
        </button>
        <button
          class="filter-tab"
          [class.active]="selectedType === 'paint_correction'"
          (click)="onFilterChange('paint_correction')"
        >
          {{ getServiceTypeIcon("paint_correction") }}
          {{ getServiceTypeLabel("paint_correction") }}
        </button>
        <button
          class="filter-tab"
          [class.active]="selectedType === 'body_correction'"
          (click)="onFilterChange('body_correction')"
        >
          {{ getServiceTypeIcon("body_correction") }}
          {{ getServiceTypeLabel("body_correction") }}
        </button>
        <button
          class="filter-tab"
          [class.active]="selectedType === 'ceramic_coating'"
          (click)="onFilterChange('ceramic_coating')"
        >
          {{ getServiceTypeIcon("ceramic_coating") }}
          {{ getServiceTypeLabel("ceramic_coating") }}
        </button>
      </div>

      <!-- Loading State -->
      <app-loading-spinner
        *ngIf="loading"
        [size]="'medium'"
        [message]="'Chargement des services...'"
        [color]="'primary'"
      >
      </app-loading-spinner>

      <!-- Empty State -->
      <div class="empty-state" *ngIf="!loading && services.length === 0">
        <div class="empty-icon">‚öôÔ∏è</div>
        <p>Aucun service trouv√©</p>
      </div>

      <!-- Services Grid - Grouped by Type -->
      <div
        class="services-grid"
        *ngIf="!loading && filteredServices.length > 0"
      >
        <div
          class="service-group-card"
          *ngFor="let group of getGroupedServicesArray()"
        >
          <!-- Service Type Header -->
          <div class="service-type-header">
            <h2>{{ getServiceTypeLabel(group.type) }}</h2>
            <span class="service-count"
              >{{ getServiceVariants(group.services[0]).length }} variante(s) de
              prix</span
            >
          </div>

          <!-- Service Variations -->
          <div class="service-variations">
            <div
              class="service-variation"
              *ngFor="let service of group.services"
            >
              <!-- Display all variants for this service -->
              <div class="variants-container">
                <div
                  class="variant-item"
                  *ngFor="let variant of getServiceVariants(service)"
                >
                  <!-- Car Type Badge -->
                  <div class="car-type-badge">
                    <span *ngIf="variant.type === 'all'">üè† Prix unique</span>
                    <span *ngIf="variant.type !== 'all'"
                      >üöó {{ getCarTypeLabel(variant.type) }}</span
                    >
                  </div>

                  <!-- Variant Info -->
                  <div class="service-info">
                    <div class="service-meta">
                      <div class="meta-item">
                        <span class="meta-icon">üí∞</span>
                        <span class="meta-value">{{ variant.price }} TND</span>
                      </div>
                      <div class="meta-item">
                        <span class="meta-icon">‚è±Ô∏è</span>
                        <span class="meta-value">{{
                          formatDuration(variant.duration)
                        }}</span>
                      </div>
                      <div class="meta-item" *ngIf="service.type !== 'salon'">
                        <span class="meta-icon">üìç</span>
                        <span class="meta-value"
                          >{{
                            getActiveServiceLocations(service).length
                          }}
                          location(s)</span
                        >
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Service Info (locations) -->
              <div class="service-info">
                <div class="service-meta"></div>

                <!-- At-home service message for salon type -->
                <div class="at-home-message" *ngIf="service.type === 'salon'">
                  <span class="home-icon">üè†</span>
                  <span>Service √† domicile</span>
                </div>

                <!-- Locations list for other types -->
                <div class="service-locations" *ngIf="service.type !== 'salon'">
                  <div
                    class="location-item"
                    *ngFor="let location of getActiveServiceLocations(service)"
                  >
                    <span class="location-icon">üìç</span>
                    <div class="location-details">
                      <span class="location-address">{{
                        location.address
                      }}</span>
                      <small class="location-coordinates">
                        {{ location.coordinates[1] }},
                        {{ location.coordinates[0] }}
                      </small>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Service Actions -->
              <div class="service-actions">
                <button
                  class="action-btn edit-btn"
                  (click)="onEditService(service)"
                >
                  ‚úèÔ∏è Modifier
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Filtered Empty State -->
      <div
        class="empty-state"
        *ngIf="!loading && services.length > 0 && filteredServices.length === 0"
      >
        <div class="empty-icon">üîç</div>
        <p>Aucun service trouv√© pour ce type</p>
      </div>
    </div>

    <!-- Locations View -->
    <div *ngIf="viewMode === 'locations'">
      <div class="locations-header">
        <button class="add-location-btn" (click)="onAddLocation()">
          ‚ûï Ajouter une localisation
        </button>
      </div>

      <!-- Loading State -->
      <app-loading-spinner
        *ngIf="locationsLoading"
        [size]="'medium'"
        [message]="'Chargement des localisations...'"
        [color]="'primary'"
      >
      </app-loading-spinner>

      <!-- Empty State -->
      <div
        class="empty-state"
        *ngIf="!locationsLoading && locations.length === 0"
      >
        <div class="empty-icon">üìç</div>
        <p>Aucune localisation trouv√©e</p>
        <button class="add-first-btn" (click)="onAddLocation()">
          Ajouter la premi√®re localisation
        </button>
      </div>

      <!-- Locations Table -->
      <div
        class="locations-table-container"
        *ngIf="!locationsLoading && locations.length > 0"
      >
        <table class="locations-table">
          <thead>
            <tr>
              <th>Statut</th>
              <th>Adresse</th>
              <th>Coordonn√©es</th>
              <th>Services</th>
              <th>√âquipes</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let location of locations">
              <!-- Status -->
              <td>
                <span class="status-badge" [class.inactive]="!location.isActive">
                  {{ location.isActive ? "‚úÖ Active" : "‚õî Inactive" }}
                </span>
              </td>

              <!-- Address -->
              <td>
                <div class="address-cell">
                  <span class="address-icon">üìç</span>
                  <span class="address-text">{{ location.address }}</span>
                </div>
              </td>

              <!-- Coordinates -->
              <td>
                <div class="coordinates-cell">
                  <div class="coord-value">{{ location.coordinates[1] | number : "1.4-4" }}</div>
                  <div class="coord-value">{{ location.coordinates[0] | number : "1.4-4" }}</div>
                </div>
              </td>

              <!-- Services Count -->
              <td>
                <div class="services-cell">
                  <span class="service-count-badge">
                    üîó {{ getServicesUsingLocation(location) }} service(s)
                  </span>
                </div>
              </td>

              <!-- Teams -->
              <td>
                <div class="teams-cell">
                  <div class="teams-badges" *ngIf="getTeamCountForLocation(location) > 0">
                    <span
                      class="team-badge"
                      *ngFor="let teamName of getTeamsForLocation(location)"
                    >
                      {{ teamName }}
                    </span>
                  </div>
                  <span class="no-teams" *ngIf="getTeamCountForLocation(location) === 0">
                    Aucune √©quipe
                  </span>
                </div>
              </td>

              <!-- Actions -->
              <td>
                <div class="table-actions">
                  <button
                    class="action-btn-sm edit-btn"
                    (click)="onEditLocation(location)"
                    title="Modifier"
                  >
                    ‚úèÔ∏è
                  </button>
                  <button
                    class="action-btn-sm delete-btn"
                    (click)="onDeleteLocation(location)"
                    title="Supprimer"
                  >
                    üóëÔ∏è
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div
  class="modal-overlay"
  *ngIf="showDeleteConfirm"
  (click)="closeDeleteConfirm()"
>
  <div class="modal-content delete-confirm" (click)="$event.stopPropagation()">
    <h3>Confirmer la suppression</h3>
    <p *ngIf="serviceToDelete">
      √ätes-vous s√ªr de vouloir supprimer le service
      <strong>{{ getServiceTypeLabel(serviceToDelete.type) }}</strong> ?
    </p>
    <p *ngIf="locationToDelete">
      √ätes-vous s√ªr de vouloir supprimer la localisation
      <strong>{{ locationToDelete.address }}</strong> ?
    </p>
    <p class="warning-text">Cette action est irr√©versible.</p>
    <div class="modal-actions">
      <button
        class="btn-secondary"
        (click)="closeDeleteConfirm()"
        [disabled]="deleteLoading"
      >
        Annuler
      </button>
      <button
        class="btn-danger"
        (click)="confirmDelete()"
        [disabled]="deleteLoading"
      >
        {{ deleteLoading ? "Suppression..." : "Supprimer" }}
      </button>
    </div>
  </div>
</div>
