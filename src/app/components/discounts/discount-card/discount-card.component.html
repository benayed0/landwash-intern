<div class="discount-card" [class.editing]="isEditing()">
  <!-- Card Header -->
  <div class="card-header">
    <div class="discount-code">
      <span class="code-label">Code:</span>
      <span class="code-value" *ngIf="!isEditing()">{{ discount.code }}</span>
      <mat-form-field *ngIf="isEditing()" appearance="outline" class="code-form-field">
        <input
          matInput
          [(ngModel)]="editForm().code"
          placeholder="Code de réduction"
          style="text-transform: uppercase"
        />
      </mat-form-field>
    </div>
    <div class="card-actions">
      <mat-chip [class]="'status-chip ' + statusColor()">
        {{ statusText() }}
      </mat-chip>
      <div class="action-buttons" *ngIf="!isEditing()">
        <button
          mat-icon-button
          class="edit-btn"
          (click)="startEdit()"
          title="Modifier"
        >
          <mat-icon>edit</mat-icon>
        </button>
        <button
          mat-icon-button
          class="delete-btn"
          (click)="confirmDelete()"
          title="Supprimer"
        >
          <mat-icon>delete</mat-icon>
        </button>
      </div>
    </div>
  </div>

  <!-- Card Content -->
  <div class="card-content">
    <div class="discount-info">
      <!-- Type and Value -->
      <div class="info-row">
        <div class="info-item">
          <span class="label">Type:</span>
          <span *ngIf="!isEditing()" class="value">
            {{
              discount.type === "percentage" ? "Pourcentage" : "Montant Fixe"
            }}
          </span>
          <mat-form-field *ngIf="isEditing()" appearance="outline" class="compact-field">
            <mat-select [(ngModel)]="editForm().type" placeholder="Type de réduction">
              <mat-option
                *ngFor="let option of discountTypeOptions"
                [value]="option.value"
              >
                {{ option.label }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>
        <div class="info-item">
          <span class="label">Valeur:</span>
          <span *ngIf="!isEditing()" class="value highlight">
            {{ formatValue(discount.type, discount.value) }}
          </span>
          <mat-form-field *ngIf="isEditing()" appearance="outline" class="compact-field">
            <input
              matInput
              type="number"
              [(ngModel)]="editForm().value"
              [min]="0"
              [max]="editForm().type === 'percentage' ? 100 : 999999"
              placeholder="Valeur"
            />
            <span matSuffix class="suffix-text">
              {{ editForm().type === "percentage" ? "%" : " DT" }}
            </span>
          </mat-form-field>
        </div>
      </div>

      <!-- Usage Statistics -->
      <div class="info-row">
        <div class="info-item">
          <span class="label">Utilisations:</span>
          <span class="value"
            >{{ discount.usedCount }} / {{ discount.maxUses }}</span
          >
        </div>
        <div class="info-item" *ngIf="!isEditing()">
          <span class="label">Progression:</span>
          <div class="progress-container">
            <mat-progress-bar
              mode="determinate"
              [value]="usagePercentage()"
              [class.full]="usagePercentage() >= 100"
            ></mat-progress-bar>
            <span class="progress-text">{{ usagePercentage() }}%</span>
          </div>
        </div>
        <div class="info-item" *ngIf="isEditing()">
          <span class="label">Max. utilisations:</span>
          <mat-form-field appearance="outline" class="compact-field">
            <input
              matInput
              type="number"
              [(ngModel)]="editForm().maxUses"
              [min]="discount.usedCount"
              placeholder="Maximum d'utilisations"
            />
          </mat-form-field>
        </div>
      </div>

      <!-- Expiration Date -->
      <div class="info-row">
        <div class="info-item">
          <span class="label">Expire le:</span>
          <span
            *ngIf="!isEditing()"
            class="value"
            [class.expired]="isExpired()"
          >
            {{ formatDate(discount.expiresAt) }}
          </span>
          <mat-form-field *ngIf="isEditing()" appearance="outline" class="compact-field">
            <input
              matInput
              [matDatepicker]="picker"
              [(ngModel)]="editForm().expiresAt"
              placeholder="Date d'expiration"
            />
            <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
            <mat-datepicker #picker></mat-datepicker>
          </mat-form-field>
        </div>
      </div>

      <!-- Applicable Products -->
      <div class="info-row">
        <div class="info-item full-width">
          <span class="label">Produits applicables:</span>
          <span *ngIf="!isEditing()" class="value">
            {{ getProductNames(discount.applicableProducts || []) }}
          </span>
          <mat-form-field *ngIf="isEditing()" appearance="outline" class="compact-field full-width">
            <mat-select
              [(ngModel)]="editForm().applicableProducts"
              placeholder="Sélectionner les produits (vide = tous)"
              multiple
            >
              <mat-option
                *ngFor="let product of products()"
                [value]="product._id"
              >
                {{ product.name }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>
      </div>

      <!-- Applicable Services -->
      <div class="info-row">
        <div class="info-item full-width">
          <span class="label">Services applicables:</span>
          <span *ngIf="!isEditing()" class="value">
            {{ getServiceNames(discount.services || []) }}
          </span>
          <mat-form-field *ngIf="isEditing()" appearance="outline" class="compact-field full-width">
            <mat-select
              [(ngModel)]="editForm().services"
              placeholder="Sélectionner les services (vide = tous)"
              multiple
            >
              <mat-option
                *ngFor="let service of serviceTypeOptions"
                [value]="service.value"
              >
                {{ service.label }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>
      </div>

      <!-- Options -->
      <div class="info-row">
        <div class="info-item">
          <span class="label">Première commande uniquement:</span>
          <span *ngIf="!isEditing()" class="value">
            {{ discount.firstOrderOnly ? "Oui" : "Non" }}
          </span>
          <mat-slide-toggle
            *ngIf="isEditing()"
            [(ngModel)]="editForm().firstOrderOnly"
            color="primary"
          ></mat-slide-toggle>
        </div>
        <div class="info-item">
          <span class="label">Statut:</span>
          <span *ngIf="!isEditing()" class="value">
            {{ discount.active ? "Actif" : "Inactif" }}
          </span>
          <mat-slide-toggle
            *ngIf="isEditing()"
            [(ngModel)]="editForm().active"
            color="primary"
          ></mat-slide-toggle>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Actions -->
  <div class="edit-actions" *ngIf="isEditing()">
    <button mat-stroked-button class="cancel-btn" (click)="cancelEdit()">
      <mat-icon>close</mat-icon>
      Annuler
    </button>
    <button mat-raised-button color="primary" class="save-btn" (click)="saveChanges()">
      <mat-icon>check</mat-icon>
      Sauvegarder
    </button>
  </div>

  <!-- Quick Toggle (when not editing) -->
  <div class="quick-actions" *ngIf="!isEditing()">
    <button
      mat-stroked-button
      class="toggle-btn"
      [class.active]="discount.active"
      (click)="toggleActive()"
    >
      <mat-icon>{{ discount.active ? "visibility" : "visibility_off" }}</mat-icon>
      {{ discount.active ? "Désactiver" : "Activer" }}
    </button>
  </div>
</div>
