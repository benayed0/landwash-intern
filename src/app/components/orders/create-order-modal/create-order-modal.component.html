<div class="modal-overlay" *ngIf="isOpen" (click)="onCancel()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Cr√©er une Commande</h2>
      <button class="close-btn" (click)="onCancel()" type="button">√ó</button>
    </div>

    <div class="modal-body">
      <!-- Product Selection Section -->
      <div class="section">
        <h3>S√©lection des Produits</h3>

        <!-- Product Search -->
        <div class="search-container">
          <input
            type="text"
            pInputText
            placeholder="Rechercher un produit..."
            [value]="productSearchQuery()"
            (input)="onProductSearch($event)"
            class="search-input"
          />
          <i class="pi pi-search search-icon"></i>
        </div>

        <!-- Product List -->
        <div class="products-grid">
          <div *ngIf="isLoadingProducts()" class="loading-state">
            <p-skeleton
              height="100px"
              *ngFor="let item of [1, 2, 3, 4]"
            ></p-skeleton>
          </div>

          <div
            *ngFor="let product of filteredProducts()"
            class="product-card"
            (click)="addProduct(product)"
          >
            <div class="product-image">
              <img
                *ngIf="
                  product.pictures && product.pictures.length > 0;
                  else noImage
                "
                [src]="product.pictures[0]"
                [alt]="product.name"
              />
              <ng-template #noImage>
                <div class="no-image">
                  <i class="pi pi-image"></i>
                </div>
              </ng-template>
            </div>
            <div class="product-info">
              <h4>{{ product.name }}</h4>
              <p class="product-type">{{ product.type }}</p>
              <p class="product-price">{{ product.price }} DT</p>
            </div>
            <button class="add-btn" type="button">
              <i class="pi pi-plus">+</i>
            </button>
          </div>
        </div>
      </div>

      <!-- Selected Products Section -->
      <div class="section" *ngIf="selectedProducts().length > 0">
        <h3>Produits S√©lectionn√©s</h3>
        <div class="selected-products">
          <div
            *ngFor="let item of selectedProducts()"
            class="selected-product-item"
          >
            <div class="product-summary">
              <span class="product-name">{{ item.product.name }}</span>
              <span class="product-unit-price"
                >{{ item.product.price }} DT/unit√©</span
              >
            </div>
            <div class="quantity-controls">
              <button
                type="button"
                class="quantity-btn"
                (click)="
                  updateProductQuantity(item.product._id, item.quantity - 1)
                "
              >
                <i class="pi pi-minus">‚àí</i>
              </button>
              <input
                type="number"
                [value]="item.quantity"
                (change)="
                  updateProductQuantity(
                    item.product._id,
                    +$any($event.target).value
                  )
                "
                min="1"
                class="quantity-input"
              />
              <button
                type="button"
                class="quantity-btn"
                (click)="
                  updateProductQuantity(item.product._id, item.quantity + 1)
                "
              >
                <i class="pi pi-plus">+</i>
              </button>
            </div>
            <div class="item-total">{{ item.totalPrice }} DT</div>
            <button
              type="button"
              class="remove-btn"
              (click)="removeProduct(item.product._id)"
            >
              <i class="pi pi-trash">üóë</i>
            </button>
          </div>
        </div>

        <!-- Price Summary -->
        <div class="price-summary">
          <div class="calculated-price">
            <span>Prix calcul√©: {{ calculatedTotalPrice() }} DT</span>
          </div>
          <div class="manual-price">
            <label>Prix manuel (optionnel):</label>
            <p-inputNumber
              [ngModel]="manualTotalPrice()"
              (ngModelChange)="manualTotalPrice.set($event)"
              mode="decimal"
              suffix=" DT"
              [min]="0"
              placeholder="Laisser vide pour utiliser le prix calcul√©"
              [ngModelOptions]="{ standalone: true }"
            ></p-inputNumber>
            <button
              *ngIf="manualTotalPrice() !== null"
              type="button"
              class="reset-price-btn"
              (click)="resetManualPrice()"
            >
              <i class="pi pi-refresh"></i> R√©initialiser
            </button>
          </div>
          <div class="final-price">
            <strong>Prix final: {{ finalTotalPrice() }} DT</strong>
          </div>
        </div>
      </div>

      <!-- User Selection Section -->
      <div class="section">
        <h3>S√©lection du Client</h3>
        <p-dropdown
          [options]="users()"
          [ngModel]="selectedUser()"
          (ngModelChange)="selectedUser.set($event)"
          optionLabel="name"
          placeholder="S√©lectionner un client"
          [filter]="true"
          filterBy="name,email"
          class="user-dropdown"
          [loading]="isLoadingUsers()"
          [ngModelOptions]="{ standalone: true }"
        >
          <ng-template pTemplate="selectedItem" let-user>
            <div *ngIf="user" class="selected-user">
              <span>{{ getUserDisplayName(user) }}</span>
            </div>
          </ng-template>
          <ng-template pTemplate="item" let-user>
            <div class="user-option">
              <div class="user-name">{{ user.name }}</div>
              <div class="user-email">{{ user.phoneNumber }}</div>
            </div>
          </ng-template>
        </p-dropdown>
      </div>

      <!-- Location Selection Section -->
      <div class="section">
        <h3>Adresse de Livraison</h3>
        <app-location-picker
          (locationSelected)="onLocationSelected($event)"
          placeholder="Rechercher une adresse de livraison..."
        ></app-location-picker>
      </div>

      <!-- Payment Method Section -->
      <div class="section">
        <h3>Mode de Paiement</h3>
        <div class="payment-methods">
          <div class="payment-option">
            <p-radioButton
              name="paymentMethod"
              value="cash"
              [ngModel]="paymentMethod()"
              (ngModelChange)="paymentMethod.set($event)"
              inputId="cash"
            ></p-radioButton>
            <label for="cash" class="payment-label">
              <i class="pi pi-money-bill"></i>
              Esp√®ces
            </label>
          </div>
          <div class="payment-option">
            <p-radioButton
              name="paymentMethod"
              value="card"
              [ngModel]="paymentMethod()"
              (ngModelChange)="paymentMethod.set($event)"
              inputId="card"
            ></p-radioButton>
            <label for="card" class="payment-label">
              <i class="pi pi-credit-card"></i>
              Carte
            </label>
          </div>
        </div>
      </div>

      <!-- Notes Section -->
      <div class="section">
        <h3>Notes (Optionnel)</h3>
        <textarea
          pTextarea
          [value]="notes()"
          (input)="notes.set($any($event.target).value)"
          placeholder="Ajouter des notes pour cette commande..."
          rows="3"
          class="notes-textarea"
        ></textarea>
      </div>
    </div>

    <div class="modal-footer">
      <button
        type="button"
        class="cancel-btn"
        (click)="onCancel()"
        [disabled]="isSubmitting()"
      >
        Annuler
      </button>
      <button
        type="button"
        class="submit-btn"
        (click)="onSubmit()"
        [disabled]="isSubmitting() || selectedProducts().length === 0"
      >
        <i class="pi pi-spin pi-spinner" *ngIf="isSubmitting()"></i>
        <i class="pi pi-check" *ngIf="!isSubmitting()"></i>
        {{ isSubmitting() ? "Cr√©ation..." : "Cr√©er la Commande" }}
      </button>
    </div>
  </div>
</div>
