<div class="modal-overlay" *ngIf="isOpen" (click)="onCancel()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>
        <mat-icon>shopping_cart</mat-icon>
        Créer une Commande
      </h2>
      <button mat-icon-button class="close-btn" (click)="onCancel()" type="button">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <div class="modal-body">
      <!-- Product Selection Section -->
      <div class="section">
        <h3>
          <mat-icon>inventory</mat-icon>
          Sélection des Produits
        </h3>

        <!-- Product Search -->
        <mat-form-field appearance="outline" class="search-field">
          <mat-label>Rechercher un produit</mat-label>
          <input
            matInput
            placeholder="Rechercher un produit..."
            [value]="productSearchQuery()"
            (input)="onProductSearch($event)"
          />
          <mat-icon matPrefix>search</mat-icon>
        </mat-form-field>

        <!-- Product List -->
        <div class="products-grid">
          <div *ngIf="isLoadingProducts()" class="loading-state">
            <mat-card *ngFor="let item of [1, 2, 3, 4]" class="skeleton-card">
              <mat-spinner diameter="40"></mat-spinner>
            </mat-card>
          </div>

          <mat-card
            *ngFor="let product of filteredProducts()"
            class="product-card"
            (click)="addProduct(product)"
          >
            <div class="product-image">
              <img
                *ngIf="
                  product.pictures && product.pictures.length > 0;
                  else noImage
                "
                [src]="product.pictures[0]"
                [alt]="product.name"
              />
              <ng-template #noImage>
                <div class="no-image">
                  <mat-icon>image</mat-icon>
                </div>
              </ng-template>
            </div>
            <mat-card-content class="product-info">
              <h4>{{ product.name }}</h4>
              <span class="product-type">{{ product.type }}</span>
              <p class="product-price">{{ product.price }} DT</p>
            </mat-card-content>
            <button mat-mini-fab class="add-btn" type="button" color="primary">
              <mat-icon>add</mat-icon>
            </button>
          </mat-card>
        </div>
      </div>

      <!-- Selected Products Section -->
      <div class="section" *ngIf="selectedProducts().length > 0">
        <h3>
          <mat-icon>shopping_basket</mat-icon>
          Produits Sélectionnés
        </h3>
        <div class="selected-products">
          <div
            *ngFor="let item of selectedProducts()"
            class="selected-product-item"
          >
            <div class="product-summary">
              <span class="product-name">{{ item.product.name }}</span>
              <span class="product-unit-price"
                >{{ item.product.price }} DT/unité</span
              >
            </div>
            <div class="quantity-controls">
              <button
                mat-icon-button
                type="button"
                (click)="
                  updateProductQuantity(item.product._id, item.quantity - 1)
                "
              >
                <mat-icon>remove</mat-icon>
              </button>
              <input
                type="number"
                [value]="item.quantity"
                (change)="
                  updateProductQuantity(
                    item.product._id,
                    +$any($event.target).value
                  )
                "
                min="1"
                class="quantity-input"
              />
              <button
                mat-icon-button
                type="button"
                (click)="
                  updateProductQuantity(item.product._id, item.quantity + 1)
                "
              >
                <mat-icon>add</mat-icon>
              </button>
            </div>
            <div class="item-total">{{ item.totalPrice }} DT</div>
            <button
              mat-icon-button
              type="button"
              class="remove-btn"
              (click)="removeProduct(item.product._id)"
              color="warn"
            >
              <mat-icon>delete</mat-icon>
            </button>
          </div>
        </div>

        <!-- Price Summary -->
        <div class="price-summary">
          <div class="calculated-price">
            <span>Prix calculé: {{ calculatedTotalPrice() }} DT</span>
          </div>
          <mat-form-field appearance="outline" class="manual-price-field">
            <mat-label>Prix manuel (optionnel)</mat-label>
            <input
              matInput
              type="number"
              [ngModel]="manualTotalPrice()"
              (ngModelChange)="manualTotalPrice.set($event)"
              [min]="0"
              placeholder="Laisser vide pour utiliser le prix calculé"
            />
            <span matSuffix> DT</span>
            <button
              *ngIf="manualTotalPrice() !== null"
              mat-icon-button
              matSuffix
              type="button"
              (click)="resetManualPrice()"
              matTooltip="Réinitialiser"
            >
              <mat-icon>refresh</mat-icon>
            </button>
          </mat-form-field>
          <div class="final-price">
            <strong>Prix final: {{ finalTotalPrice() }} DT</strong>
          </div>
        </div>
      </div>

      <!-- User Selection Section -->
      <div class="section">
        <h3>
          <mat-icon>person</mat-icon>
          Sélection du Client
        </h3>
        <mat-form-field appearance="outline" class="user-field">
          <mat-label>Sélectionner un client</mat-label>
          <mat-select
            [ngModel]="selectedUser()"
            (ngModelChange)="selectedUser.set($event)"
            [disabled]="isLoadingUsers()"
          >
            <mat-option *ngFor="let user of users()" [value]="user">
              <div class="user-option">
                <div class="user-name">{{ user.name }}</div>
                <div class="user-email">{{ user.phoneNumber }}</div>
              </div>
            </mat-option>
          </mat-select>
          <mat-icon matPrefix>person</mat-icon>
          <mat-spinner
            *ngIf="isLoadingUsers()"
            matSuffix
            diameter="20"
          ></mat-spinner>
        </mat-form-field>
      </div>

      <!-- Location Selection Section -->
      <div class="section">
        <h3>
          <mat-icon>location_on</mat-icon>
          Adresse de Livraison
        </h3>
        <app-location-picker
          (locationSelected)="onLocationSelected($event)"
          placeholder="Rechercher une adresse de livraison..."
        ></app-location-picker>
      </div>

      <!-- Payment Method Section -->
      <div class="section">
        <h3>
          <mat-icon>payment</mat-icon>
          Mode de Paiement
        </h3>
        <mat-radio-group
          [ngModel]="paymentMethod()"
          (ngModelChange)="paymentMethod.set($event)"
          class="payment-methods"
        >
          <mat-radio-button value="cash" class="payment-option">
            <div class="payment-label">
              <mat-icon>payments</mat-icon>
              Espèces
            </div>
          </mat-radio-button>
          <mat-radio-button value="card" class="payment-option">
            <div class="payment-label">
              <mat-icon>credit_card</mat-icon>
              Carte
            </div>
          </mat-radio-button>
        </mat-radio-group>
      </div>

      <!-- Notes Section -->
      <div class="section">
        <h3>
          <mat-icon>note</mat-icon>
          Notes (Optionnel)
        </h3>
        <mat-form-field appearance="outline" class="notes-field">
          <mat-label>Ajouter des notes</mat-label>
          <textarea
            matInput
            [value]="notes()"
            (input)="notes.set($any($event.target).value)"
            placeholder="Ajouter des notes pour cette commande..."
            rows="3"
          ></textarea>
        </mat-form-field>
      </div>
    </div>

    <div class="modal-footer">
      <button
        mat-stroked-button
        type="button"
        (click)="onCancel()"
        [disabled]="isSubmitting()"
      >
        <mat-icon>close</mat-icon>
        Annuler
      </button>
      <button
        mat-raised-button
        color="primary"
        type="button"
        (click)="onSubmit()"
        [disabled]="isSubmitting() || selectedProducts().length === 0"
      >
        <mat-icon *ngIf="isSubmitting()" class="spinning">hourglass_empty</mat-icon>
        <mat-icon *ngIf="!isSubmitting()">check</mat-icon>
        {{ isSubmitting() ? "Création..." : "Créer la Commande" }}
      </button>
    </div>
  </div>
</div>
